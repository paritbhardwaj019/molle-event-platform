generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  HOST
  REFERRER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum EventType {
  NORMAL
  INVITE_ONLY
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum InviteStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ReferralLinkType {
  SIGNUP
  EVENT
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  password      String?
  name          String
  phone         String?
  avatar        String?
  role          UserRole    @default(USER)
  status        UserStatus  @default(ACTIVE)
  emailVerified DateTime?
  
  googleId      String?     @unique
  facebookId    String?     @unique
  
  walletBalance Decimal     @default(0) @db.Decimal(10,2)
  referralCode  String?     @unique
  referredBy    String?     
  referredByHostId String?  
  usedReferrerCodeId String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  accounts           Account[]
  sessions           Session[]
  hostedEvents       Event[]           @relation("EventHost")
  bookings           Booking[]
  reviews            Review[]
  referrals          Referral[]        @relation("ReferrerUser")
  referredUsers      Referral[]        @relation("ReferredUser")
  inviteRequests     InviteRequest[]
  payouts            Payout[]
  referralLinks      ReferralLink[]    @relation("ReferrerLinks")
  allowedEvents      Event[]           @relation("EventAllowedReferrers")
  hostReferrers      User[]            @relation("HostReferrers")
  referrerHost       User?             @relation("HostReferrers", fields: [referredByHostId], references: [id])
  
  hostReferrerCodes  HostReferrerCode[] @relation("HostReferrerCodes")
  usedReferrerCode   HostReferrerCode?  @relation("ReferrerUsers", fields: [usedReferrerCodeId], references: [id])
  
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Event {
  id            String      @id @default(cuid())
  title         String
  description   String      @db.Text
  coverImage    String
  slug          String      @unique
  eventType     EventType   @default(NORMAL)
  status        EventStatus @default(DRAFT)
  
  minAge        Int?
  maxAge        Int?
  
  maxTickets    Int
  soldTickets   Int         @default(0)
  
  organizerName String
  organizerBio  String?     @db.Text
  
  startDate     DateTime
  endDate       DateTime
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  enableReferrers Boolean @default(false)  @map("enable_referrers")
  
  hostId        String
  host          User        @relation("EventHost", fields: [hostId], references: [id])
  amenities     EventAmenity[]
  packages      Package[]
  bookings      Booking[]
  reviews       Review[]
  inviteRequests InviteRequest[]
  referralLinks      ReferralLink[]    @relation("EventReferralLinks")
  allowedReferrers   User[]            @relation("EventAllowedReferrers")
  
  @@map("events")
}

model Amenity {
  id          String         @id @default(cuid())
  name        String         @unique
  icon        String?
  description String?
  
  events      EventAmenity[]
  
  @@map("amenities")
}

model EventAmenity {
  id        String @id @default(cuid())
  eventId   String
  amenityId String
  
  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  amenity   Amenity @relation(fields: [amenityId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, amenityId])
  @@map("event_amenities")
}

model Package {
  id          String    @id @default(cuid())
  name        String
  description String?   @db.Text
  price       Decimal   @db.Decimal(10,2)
  maxTickets  Int?      
  benefits    String[] 
  
  eventId     String
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  bookings    Booking[]
  
  @@map("packages")
}

model Booking {
  id              String        @id @default(cuid())
  bookingNumber   String        @unique
  status          BookingStatus @default(PENDING)
  ticketCount     Int
  totalAmount     Decimal       @db.Decimal(10,2)
  
  referralCode    String?
  referralDiscount Decimal      @default(0) @db.Decimal(10,2)
  
  bookedAt        DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  eventId         String
  event           Event         @relation(fields: [eventId], references: [id])
  packageId       String
  package         Package       @relation(fields: [packageId], references: [id])
  payment         Payment?
  referralLinkId   String?
  referralLink     ReferralLink?    @relation("LinkBookings", fields: [referralLinkId], references: [id])
  
  @@map("bookings")
}

model Payment {
  id              String        @id @default(cuid())
  razorpayOrderId String        @unique
  razorpayPaymentId String?     @unique
  amount          Decimal       @db.Decimal(10,2)
  currency        String        @default("INR")
  status          PaymentStatus @default(PENDING)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  bookingId       String        @unique
  booking         Booking       @relation(fields: [bookingId], references: [id])
  
  @@map("payments")
}

model Review {
  id        String   @id @default(cuid())
  rating    Int      
  comment   String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])
  
  @@unique([userId, eventId])
  @@map("reviews")
}

model Referral {
  id              String   @id @default(cuid())
  referralCode    String
  commission      Decimal  @db.Decimal(10,2)
  isCommissionPaid Boolean @default(false)
  
  createdAt       DateTime @default(now())
  
  referrerId      String  
  referrer        User     @relation("ReferrerUser", fields: [referrerId], references: [id])
  referredUserId  String  
  referredUser    User     @relation("ReferredUser", fields: [referredUserId], references: [id])
  referralLinkId   String?
  referralLink     ReferralLink?    @relation("LinkSignups", fields: [referralLinkId], references: [id])
  
  @@unique([referrerId, referredUserId])
  @@map("referrals")
}

model Payout {
  id          String       @id @default(cuid())
  amount      Decimal      @db.Decimal(10,2)
  status      PayoutStatus @default(PENDING)
  
  accountNumber String?
  ifscCode     String?
  accountName  String?
  
  razorpayPayoutId String? @unique
  
  requestedAt DateTime     @default(now())
  processedAt DateTime?
  
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  
  @@map("payouts")
}

model InviteRequest {
  id        String       @id @default(cuid())
  status    InviteStatus @default(PENDING)
  message   String?      @db.Text
  
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  eventId   String
  event     Event        @relation(fields: [eventId], references: [id])
  
  @@unique([userId, eventId])
  @@map("invite_requests")
}

model ReferralLink {
  id            String          @id @default(cuid())
  referralCode  String          @unique
  type          ReferralLinkType
  eventId       String?
  hostId        String?
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  referrerId    String
  referrer      User            @relation("ReferrerLinks", fields: [referrerId], references: [id])
  event         Event?          @relation("EventReferralLinks", fields: [eventId], references: [id])
  signups       Referral[]      @relation("LinkSignups")
  bookings      Booking[]       @relation("LinkBookings")
  
  @@map("referral_links")
}

model HostReferrerCode {
  id            String      @id @default(cuid())
  code          String      @unique
  description   String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  hostId        String
  host          User        @relation("HostReferrerCodes", fields: [hostId], references: [id])
  referrers     User[]      @relation("ReferrerUsers")
  
  @@map("host_referrer_codes")
} 

model PlatformSetting {
  id               String   @id @default(cuid())
  key              String   @unique
  value            String
  displayName      String
  description      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("platform_settings")
}